<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <title>Object Detection</title>
</head>
<body>
    <div id="nav-placeholder"></div>
    <script> 
        fetch('nav.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('nav-placeholder').innerHTML = data;
            });
    </script>

    <div class="container mt-2">
        <div class="row justify-content-center text-center">
            <div class="col-md-8">
                <h2 class="text-primary fw-bold mb-4">Image Classification</h2>
                <p id="status" class="text-muted">모델 로딩 중...</p>
                <div class="spinner-border text-primary" id="loader" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="card mt-4">
                    <div class="card-header">
                        <input class="btn btn-outline-secondary" id="input" type="file" name="file" accept="image/*" />
                    </div>
                    <img id="img" class="card-img-top"/>
                    <div class="card-body">
                        <h5 id="gps" class="bg-danger text-white p-2 rounded" style="font-size: medium;"></h5>
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modelPath = "../my_model/";
        const modelURL = modelPath + "model.json";
        const metadataURL = modelPath + "metadata.json";

        const img = document.getElementById('img');
        const result = document.getElementById('result');
        let input = document.getElementById('input');

        tmImage.load(modelURL, metadataURL, { credentials: 'same-origin' }).then(model => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status').innerHTML = "카메라로 찍거나 찍어놓은 사진을 선택하세요";

            function run() {              
                tmImage.load(modelURL, metadataURL, { credentials: 'same-origin' }).then(model => {
                    model.predict(img).then(predictions => {
                        let filteredPredictions = predictions.filter(prediction => (prediction.probability * 100).toFixed(2) > 0.00);
                        let sortedPredictions = filteredPredictions.sort((a, b) => b.probability - a.probability);
                        let tableContent = '<table class="table table-hover" style="font-size: 15px;">';
                        tableContent += '<thead class="table-light"><tr><th style="color: blue;">항목</th><th style="color: blue;">확률</th></tr></thead>';
                        sortedPredictions.forEach(prediction => {
                            tableContent += '<tr><td>' + prediction.className + '</td><td>' + (prediction.probability * 100).toFixed(2) + '%</td></tr>';
                        });
                        tableContent += '</table>';
                        result.innerHTML = tableContent;
                    });                            
                });

                EXIF.getData(img, function() {
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");

                    if (lat && lon) {
                        const latitude = convertDMSToDD(lat[0], lat[1], lat[2], EXIF.getTag(this, "GPSLatitudeRef"));
                        const longitude = convertDMSToDD(lon[0], lon[1], lon[2], EXIF.getTag(this, "GPSLongitudeRef"));
                        document.getElementById('gps').innerHTML = '<span>사진-> 위도: ' + latitude + ', 경도: ' + longitude + '</span>';
                    } else {
                        showCurrentLocation();
                    }
                });

            }

            function convertDMSToDD(degrees, minutes, seconds, direction) {
                let dd = degrees + minutes/60 + seconds/(60*60);
                if (direction == "S" || direction == "W") {
                    dd = dd * -1;
                }
                return dd;
            }
    
            function showCurrentLocation() {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    document.getElementById('gps').innerHTML = '<span>GPS-> 위도: ' + latitude + ', 경도: ' + longitude + '</span>';
                });
            }

            input.addEventListener('change', (e) => {
                img.src = URL.createObjectURL(e.target.files[0]);
            }, false);
            
            img.onload = function () {
                run();
            };

        });
    </script>
</body>
</html>
