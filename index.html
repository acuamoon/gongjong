<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.js"></script>
    <title>Object Detection</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row text-center">
            <div class="col" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
                <h2 class=" bg-primary text-white">건설 작업공종 Detection</h2>
            </div>
            <div>    
                <p id="status">Model Loading...</p>
                <div class="spinner-border text-primary" id="loader">
                </div>
                <div class="card">
                    <input class="btn btn-outline-secondary" id="input" type="file" name="file" accept="image/*" />
                    <img id="img"></img>
                    <div class="card-body">
                        <h1 id="gps" class="bg-danger text-white" style="font-size: medium;"></h1>
                        <h1 id="result"></h1>
                        <div class="d-flex justify-content-evenly">
                            <button class="btn btn-primary" id="saveBtn">저장</button>
                            <button class="btn btn-secondary">취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const modelPath = "https://acuamoon.github.io/gongjong/my_model/";
        const modelURL = modelPath + "model.json";
        const metadataURL = modelPath + "metadata.json";

        const img = document.getElementById('img');
        const result = document.getElementById('result');
        let input = document.getElementById('input');

        tmImage.load(modelURL, metadataURL, { credentials: 'same-origin' }).then(model => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status').innerHTML = "Model Loading 완료";

            function run() {              
                tmImage.load(modelURL, metadataURL, { credentials: 'same-origin' }).then(model => {
                    console.log(model);
                    model.predict(img).then(predictions => {
                        let sortedPredictions = predictions.sort((a, b) => b.probability - a.probability);
                        let tableContent = '<table class="table table-hover" style="font-size: 15px;">';
                        tableContent += '<thead class="table-light"><tr><th style="color: blue;">항목</th><th style="color: blue;">확률</th></tr></thead>';
                        sortedPredictions.forEach(prediction => {
                            tableContent += '<tr><td>' + prediction.className + '</td><td>' + (prediction.probability * 100).toFixed(2) + '%</td></tr>';
                        });
                        tableContent += '</table>';
                        result.innerHTML = tableContent;
                    });                            
                });

                EXIF.getData(img, function() {
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");
                    
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const latitude = convertDMSToDD(lat[0], lat[1], lat[2], EXIF.getTag(this, "GPSLatitudeRef"));
                        const longitude = convertDMSToDD(lon[0], lon[1], lon[2], EXIF.getTag(this, "GPSLongitudeRef"));
                        document.getElementById('gps').innerHTML = '<span">사진-> 위도: ' + latitude + ', 경도: ' + longitude + '</span>';
                    } else {
                        showCurrentLocation();
                    }
                });

            }

            function convertDMSToDD(degrees, minutes, seconds, direction) {
                let dd = degrees + minutes/60 + seconds/(60*60);
                if (direction == "S" || direction == "W") {
                    dd = dd * -1;
                }
                return dd;
            }
    
            function showCurrentLocation() {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    document.getElementById('gps').innerHTML = '<span">GPS-> 위도: ' + latitude + ', 경도: ' + longitude + '</span>';
                });
            }

            input.addEventListener('change', (e) => {
                img.src = URL.createObjectURL(e.target.files[0]);
            }, false);
            
            img.onload = function () {
                run();
            };

        });
    </script>
</body>

</html>
